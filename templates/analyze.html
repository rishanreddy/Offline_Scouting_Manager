{% extends "base.html" %}
{% set current_page = 'analysis' %}
{% import 'components/alert.html' as alert %}

{% block title %}Data Analysis - Offline Scouting Manager{% endblock %}

{% block content %}
<section class="py-4">
  <div class="container">
    <!-- Import Card -->
    <div class="card mb-4">
      <div class="card-body">
        <h2 class="h5">Import Data</h2>
        <p class="small text-muted-app">Select CSV files from scouting devices to view combined data.</p>

        <form method="post" action="{{ url_for('analyze') }}" enctype="multipart/form-data" id="uploadForm">
          <div class="mt-3">
            <label
              for="fileInput"
              id="dropZone"
              class="w-100 border border-app rounded p-4 text-center bg-app-surface-2"
              style="cursor: pointer;"
            >
              <div class="mb-2">
                <strong>Click to upload</strong> or drag and drop
              </div>
              <div class="small text-muted-app">CSV files only</div>
              <input id="fileInput" type="file" name="csv_files" multiple accept=".csv" class="d-none" />
            </label>
          </div>

          <div id="fileListContainer" class="d-none mt-3">
            <div class="bg-app-surface-2 border border-app rounded p-3">
              <div class="small fw-semibold mb-2">Selected Files</div>
              <div id="fileList" class="d-grid gap-2"></div>
            </div>
          </div>

          <div class="d-flex gap-2 mt-3">
            <button type="submit" id="submitBtn" class="btn btn-primary" disabled>Load Data</button>
            <button type="button" id="clearBtn" class="btn btn-outline-secondary d-none">Clear</button>
          </div>
        </form>

        {% if error %}
          <div class="mt-3">{{ alert.error(error) }}</div>
        {% endif %}

        {% if uploaded_filenames %}
        <div class="mt-3 p-3 border border-success rounded bg-app-surface-2">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="fw-semibold text-success">Loaded Files ({{ uploaded_filenames|length }})</div>
            <form method="POST" action="/clear_session" class="mb-0">
              <button type="submit" class="btn btn-danger btn-sm">Clear All</button>
            </form>
          </div>
          <ul class="list-unstyled mb-0">
            {% for name in uploaded_filenames %}
            <li class="small">{{ name }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      </div>
    </div>

    {% if table_rows %}
    <!-- Device Status -->
    {% if device_statuses %}
    <div class="card mb-4">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div>
            <h2 class="h6 mb-0">Device Sync Status</h2>
            <div class="small text-muted-app">
              {{ device_statuses|length }} of {{ expected_devices }} devices synced
            </div>
          </div>
          {% if expected_devices > device_statuses|length %}
          <div class="small text-muted-app">
            Missing: {{ expected_devices - device_statuses|length }}
          </div>
          {% endif %}
        </div>
        <div class="d-flex flex-wrap gap-2">
          {% for device in device_statuses %}
            <span class="badge {% if device.status == 'synced' %}bg-success{% else %}bg-secondary{% endif %}">
              {{ device.name }}
              {% if device.entries %}
                · {{ device.entries }}
              {% endif %}
            </span>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Stats Row -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="small text-muted-app">Total Entries</div>
            <div class="h4 text-primary">{{ table_rows|length }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="small text-muted-app">Unique Teams</div>
            <div class="h4">{{ teams_summary|length }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="small text-muted-app">Unique Matches</div>
            <div class="h4" id="uniqueMatches">—</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="small text-muted-app">Data Sources</div>
            <div class="h4">{{ uploaded_filenames|length if uploaded_filenames else 0 }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs border-app" id="analysisTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="teams-tab" data-bs-toggle="tab" data-bs-target="#teams" type="button" role="tab">Teams Overview</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="raw-tab" data-bs-toggle="tab" data-bs-target="#raw" type="button" role="tab">Raw Data</button>
      </li>
    </ul>
    <div class="tab-content border border-app border-top-0 p-3 bg-app-surface-2">
      <!-- Teams Tab -->
      <div class="tab-pane fade show active" id="teams" role="tabpanel">
        <div class="row g-3">
          {% for team in teams_summary %}
          <div class="col-md-6 col-lg-4">
            <a href="{{ url_for('team_info', team_number=team.team_number) }}" class="text-decoration-none">
              <div class="card h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="h5 mb-0">Team {{ team.team_number }}</div>
                    <span class="text-primary">›</span>
                  </div>
                  <div class="small text-muted-app">Matches: {{ team.total_matches }}</div>
                  {% for field_name, field_stats in team.stats.items() %}
                    <div class="small">{{ field_name.replace('_', ' ').title() }} Avg: <strong>{{ field_stats.average }}</strong></div>
                  {% endfor %}
                </div>
              </div>
            </a>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Raw Data Tab -->
      <div class="tab-pane fade" id="raw" role="tabpanel">
        <div class="table-responsive">
          <table id="combinedTable" class="table table-dark table-striped align-middle">
            <thead>
              <tr>
                {% for col in table_columns %}
                <th>{{ col.label }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in table_rows %}
              <tr>
                {% for col in table_columns %}
                  {% set col_id = col.id|default('') %}
                  {% set value = row.get(col.id, '') %}
                  {% if 'team' in col_id|lower and value %}
                    <td><a href="{{ url_for('team_info', team_number=value) }}">{{ value }}</a></td>
                  {% else %}
                    <td>{{ value }}</td>
                  {% endif %}
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% else %}
    <div class="card">
      <div class="card-body text-center py-5">
        <div class="h5">No Data</div>
        <div class="small text-muted-app">Select CSV files above to view your scouting data.</div>
      </div>
    </div>
    {% endif %}
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("fileInput");
    const fileList = document.getElementById("fileList");
    const fileListContainer = document.getElementById("fileListContainer");
    const submitBtn = document.getElementById("submitBtn");
    const clearBtn = document.getElementById("clearBtn");

    if (dropZone) {
      dropZone.addEventListener("click", () => fileInput.click());

      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      });

      dropZone.addEventListener("drop", (e) => {
        const dt = e.dataTransfer;
        fileInput.files = dt.files;
        handleFiles(dt.files);
      });

      fileInput.addEventListener("change", (e) => handleFiles(e.target.files));

      function handleFiles(files) {
        if (files.length === 0) {
          fileListContainer.classList.add("d-none");
          submitBtn.disabled = true;
          clearBtn.classList.add("d-none");
          return;
        }

        fileList.innerHTML = "";
        Array.from(files).forEach((file) => {
          const item = document.createElement("div");
          item.className = "small";
          item.textContent = `${file.name} (${formatFileSize(file.size)})`;
          fileList.appendChild(item);
        });

        fileListContainer.classList.remove("d-none");
        submitBtn.disabled = false;
        clearBtn.classList.remove("d-none");
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + " " + sizes[i];
      }

      clearBtn.addEventListener("click", () => {
        fileInput.value = "";
        fileList.innerHTML = "";
        fileListContainer.classList.add("d-none");
        submitBtn.disabled = true;
        clearBtn.classList.add("d-none");
      });
    }

    const tableEl = document.getElementById("combinedTable");
    if (tableEl) {
      const headers = Array.from(tableEl.querySelectorAll("thead th")).map((th) =>
        th.textContent.trim().toLowerCase()
      );
      const matchIndex = headers.findIndex((h) => h.includes("match"));
      if (matchIndex >= 0) {
        const unique = new Set();
        Array.from(tableEl.querySelectorAll("tbody tr")).forEach((row) => {
          const cell = row.children[matchIndex];
          if (cell && cell.textContent.trim()) {
            unique.add(cell.textContent.trim());
          }
        });
        const uniqueMatchesEl = document.getElementById("uniqueMatches");
        if (uniqueMatchesEl) uniqueMatchesEl.textContent = unique.size;
      }
    }
  });
</script>
{% endblock %}
