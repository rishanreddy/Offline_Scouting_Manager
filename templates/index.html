{% extends "base.html" %}
{% set current_page = 'scouting' %}
{% import 'components/alert.html' as alert %}

{% block title %}Scouting Form - Offline Scouting Manager{% endblock %}

{% block content %}
<section class="py-4">
  <div class="container">
    <div class="row g-4">
      <!-- Sidebar -->
      <div class="col-lg-4">
        <div class="card">
          <div class="card-body">
            <div class="mb-3">
              <div class="text-uppercase small text-muted-app">Event</div>
              {% if event %}
                <div class="h5 mb-0">{{ event.name }}</div>
                <div class="small text-muted-app">
                  {{ event.season }}{% if event.config_id %} Â· {{ event.config_id }}{% endif %}
                </div>
              {% else %}
                <div class="h6 mb-0">No event configured</div>
              {% endif %}
            </div>

            {% if device_name %}
            <div class="mb-3">
              <div class="text-uppercase small text-muted-app">Current device</div>
              <div class="fw-semibold">{{ device_name }}</div>
            </div>
            {% endif %}

            <hr class="border-app" />

            <div class="mb-3">
              <div class="text-uppercase small text-muted-app">Data status</div>
              <div class="mt-1">
                {% if stats and stats.entries %}
                  <div class="h4 mb-0 text-primary">{{ stats.entries }}</div>
                  <div class="small text-muted-app">Last entry: {{ stats.last_timestamp }}</div>
                {% else %}
                  <div class="h4 mb-0">0</div>
                  <div class="small text-muted-app">No data yet</div>
                {% endif %}
              </div>
            </div>

            <hr class="border-app" />

            <div class="mb-3">
              <div class="text-uppercase small text-muted-app">Export</div>
              {% if stats and stats.entries > 0 %}
                <a href="{{ url_for('download_sync') }}" class="btn btn-primary w-100 mt-2">
                  Export to USB
                </a>
              {% else %}
                <button class="btn btn-secondary w-100 mt-2" disabled>
                  Export to USB
                </button>
                <div class="small text-warning mt-2">Submit data first to enable export.</div>
              {% endif %}
            </div>

            <hr class="border-app" />

            <div>
              <div class="text-uppercase small text-muted-app">Local CSV location</div>
              <code class="d-block bg-app-surface-2 border border-app rounded p-2 small mt-2">
                {{ data_path }}
              </code>
              <div class="small text-muted-app mt-2">
                Copy this file to a USB drive to merge on your analysis laptop.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Form -->
      <div class="col-lg-8">
        <div class="card">
          <div class="card-body">
            <h2 class="h4">Scouting Form</h2>
            <p class="small text-muted-app">Fill this out once per robot. Required fields are marked.</p>

            {% if request.args.get('success') == '1' %}
              {{ alert.success(
                'Entry saved at ' + stats.last_timestamp + '.' if stats and stats.last_timestamp else 'Entry saved.',
                'save-success'
              ) }}
            {% endif %}

            {% if request.args.get('reset') == '1' %}
              {{ alert.error('All local entries deleted.', 'reset-message') }}
            {% endif %}

            <form method="post" action="{{ url_for('submit_form') }}" class="mt-3">
              <div class="row g-3">
                {% for field in fields %}
                  <div class="col-12">
                    <label class="form-label">
                      {{ field.label }}
                      {% if field.required %}
                        <span class="text-danger">*</span>
                      {% endif %}
                    </label>

                    {% if field.type == "text" %}
                      <input
                        type="text"
                        name="{{ field.name }}"
                        class="form-control"
                        {% if field.required %}required{% endif %}
                      />

                    {% elif field.type == "integer" %}
                      <input
                        type="number"
                        step="1"
                        name="{{ field.name }}"
                        class="form-control"
                        {% if field.required %}required{% endif %}
                      />

                    {% elif field.type == "select" %}
                      <select
                        name="{{ field.name }}"
                        class="form-select"
                        {% if field.required %}required{% endif %}
                      >
                        <option value="" disabled selected>Select...</option>
                        {% for option in field.options %}
                          <option value="{{ option }}">{{ option }}</option>
                        {% endfor %}
                      </select>

                    {% elif field.type == "textarea" %}
                      <textarea
                        name="{{ field.name }}"
                        rows="3"
                        class="form-control"
                        {% if field.required %}required{% endif %}
                      ></textarea>

                    {% else %}
                      <input
                        type="text"
                        name="{{ field.name }}"
                        class="form-control"
                        {% if field.required %}required{% endif %}
                      />
                    {% endif %}
                  </div>
                {% endfor %}
              </div>

              <div class="d-flex justify-content-between align-items-center mt-4">
                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#resetModal">
                  Clear all data
                </button>
                <button type="submit" class="btn btn-primary">
                  Save entry
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Reset Modal -->
<div class="modal fade" id="resetModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-app-surface border border-app">
      <div class="modal-header">
        <h5 class="modal-title">Delete all data</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>This will permanently delete all scouting entries on this device. This cannot be undone.</p>
        <p class="small text-muted-app">To confirm, type <strong>Delete my data</strong> exactly as shown:</p>
        <input
          type="text"
          id="reset-confirm-input"
          placeholder="Delete my data"
          autocomplete="off"
          class="form-control"
        />
        <div class="small text-danger mt-2 d-none" id="reset-help">
          Text must exactly match "Delete my data".
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="reset-form" method="post" action="{{ url_for('reset_data') }}">
          <button type="submit" id="reset-confirm-btn" class="btn btn-danger" disabled>
            Delete all data
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const fadeAndRemove = (el) => {
      if (!el) return;
      setTimeout(() => {
        el.style.transition = "opacity 0.3s ease";
        el.style.opacity = "0";
        setTimeout(() => el.remove(), 300);
      }, 2000);
    };

    fadeAndRemove(document.getElementById("save-success"));
    fadeAndRemove(document.getElementById("reset-message"));

    if (window.history && window.history.replaceState) {
      const url = new URL(window.location);
      url.searchParams.delete("success");
      url.searchParams.delete("reset");
      window.history.replaceState({}, document.title, url.toString());
    }

    const input = document.getElementById("reset-confirm-input");
    const confirmBtn = document.getElementById("reset-confirm-btn");
    const help = document.getElementById("reset-help");
    const REQUIRED_TEXT = "Delete my data";

    if (input && confirmBtn) {
      input.addEventListener("input", () => {
        const value = input.value.trim();
        const matches = value === REQUIRED_TEXT;
        confirmBtn.disabled = !matches;
        if (!matches && value.length > 0) {
          help.classList.remove("d-none");
        } else {
          help.classList.add("d-none");
        }
      });
    }
  });
</script>
{% endblock %}
