{% extends "base.html" %}
{% set current_page = 'analysis' %}
{% block title %}Team {{ team_data.team_number }} Info - Offline Scouting Manager{% endblock %}

{% block content %}
<section class="py-4">
  <div class="container">
    <!-- Header -->
    <div class="card mb-4">
      <div class="card-body d-flex justify-content-between align-items-start">
        <div>
          <h1 class="h3 mb-1">Team {{ team_data.team_number }}</h1>
          <div class="small text-muted-app">Detailed scouting information for this team</div>
        </div>
        <a href="{{ url_for('analyze') }}" class="btn btn-outline-secondary btn-sm">Back to Analysis</a>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="small text-muted-app">Total Matches</div>
            <div class="h4 text-primary">{{ team_data.total_matches }}</div>
          </div>
        </div>
      </div>
      {% for field_name, field_stats in team_data.stats.items() %}
      <div class="col-md-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="small text-muted-app">Avg {{ field_name.replace('_', ' ').title() }}</div>
            <div class="h4">{{ field_stats.average }}</div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    {% if show_trends %}
    <!-- Performance Graphs -->
    <div class="row g-3 mb-4">
      {% for field_config in graph_fields %}
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <div class="small text-muted-app">
                  {{ field_config.label if field_config.label else field_config.field.replace('_', ' ').title() }}
                </div>
                <div class="h5 mb-0">{{ team_data.stats.get(field_config.field, {}).get('average', 0) }}</div>
              </div>
            </div>
            <canvas id="chart-{{ field_config.field }}"></canvas>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    {% if show_radar %}
    <div class="card mb-4">
      <div class="card-body">
        <h2 class="h5">Performance Overview</h2>
        <div class="mx-auto" style="max-width: 520px; max-height: 520px;">
          <canvas id="radar-chart"></canvas>
        </div>
      </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Data Table -->
    <div class="card">
      <div class="card-body">
        <h2 class="h5">Match Records</h2>
        <div class="table-responsive">
          <table id="teamMatchesTable" class="table table-dark table-striped align-middle">
            <thead>
              <tr>
                {% if team_data.matches %}
                  {% for key in team_data.matches[0].keys() %}
                  <th>{{ key.replace('_', ' ').title() }}</th>
                  {% endfor %}
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% for match in team_data.matches %}
              <tr>
                {% for value in match.values() %}
                <td>{{ value }}</td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    {% if show_trends %}
    const matches = {{ team_data.matches | tojson }};
    const matchLabels = matches.map(m => m.match || 'N/A');

    {% for field_config in graph_fields %}
    const data_{{ field_config.field }} = matches.map(m => {
      const val = parseFloat(m.{{ field_config.field }});
      return isNaN(val) ? 0 : val;
    });

    const ctx_{{ field_config.field }} = document.getElementById('chart-{{ field_config.field }}');
    if (ctx_{{ field_config.field }}) {
      new Chart(ctx_{{ field_config.field }}, {
        type: '{{ field_config.chart_type }}',
        data: {
          labels: matchLabels,
          datasets: [{
            label: {{ field_config.label | tojson }},
            data: data_{{ field_config.field }},
            backgroundColor: '{{ field_config.color }}33',
            borderColor: '{{ field_config.color }}',
            borderWidth: 2,
            tension: 0.4,
            pointBackgroundColor: '{{ field_config.color }}',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 3,
            pointHoverRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#94a3b8' } },
            y: { beginAtZero: true, ticks: { color: '#94a3b8' } }
          }
        }
      });
    }
    {% endfor %}

    {% if show_radar %}
    const radarCategories = [{% for field_config in graph_fields %}{{ field_config.label | tojson }},{% endfor %}];
    const radarData = [
      {% for radar_data_point in radar_data.values() %}
      {{ radar_data_point }},
      {% endfor %}
    ];

    const ctxRadar = document.getElementById('radar-chart');
    if (ctxRadar) {
      new Chart(ctxRadar, {
        type: 'radar',
        data: {
          labels: radarCategories,
          datasets: [{
            label: 'Relative Score',
            data: radarData,
            backgroundColor: 'rgba(59, 130, 246, 0.2)',
            borderColor: 'rgb(59, 130, 246)',
            borderWidth: 2,
            pointBackgroundColor: 'rgb(59, 130, 246)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 3,
            pointHoverRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: { legend: { labels: { color: '#94a3b8' } } },
          scales: {
            r: {
              beginAtZero: true,
              max: 100,
              grid: {
                color: 'rgba(148, 163, 184, 0.2)',
                drawBorder: true
              },
              pointLabels: { color: '#94a3b8' },
              ticks: { color: '#94a3b8', backdropColor: 'transparent' }
            }
          }
        }
      });
    }
    {% endif %}
    {% endif %}
  });
</script>
{% endblock %}
