{% extends "base.html" %}
{% set current_page = 'form_builder' %}
{% import 'components/alert.html' as alert %}

{% block title %}Form Builder - Offline Scouting Manager{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/surveyjs/core/survey-core.min.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/surveyjs/creator/survey-creator-core.min.css') }}">
<script src="{{ url_for('static', filename='vendor/surveyjs/core/survey.core.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/surveyjs/core/survey-js-ui.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/surveyjs/themes/layered-dark.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/surveyjs/creator/survey-creator-core.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/surveyjs/creator/survey-creator-js.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/surveyjs/creator/survey-creator-themes-index.min.js') }}"></script>
{% endblock %}

{% block content %}
<section class="form-builder-shell">
  <div class="form-builder-topbar border-bottom border-app">
    <div class="d-flex align-items-center justify-content-between px-3 py-2">
      <div>
        <h1 class="h6 mb-0">Survey Form Builder</h1>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span id="saveStatus" class="save-status is-saved" role="status" aria-live="polite">Saved</span>
        <a href="{{ url_for('settings') }}" class="btn btn-outline-secondary btn-sm">Back to Settings</a>
        <button type="button" id="propertyPanelToggleBtn" class="btn btn-outline-secondary btn-sm" aria-pressed="false">Show Properties</button>
        <button type="button" id="saveFormBtn" class="btn btn-primary btn-sm">Save Form</button>
      </div>
    </div>
    {% if saved %}
      <div class="px-3 pb-2">{{ alert.success('Form schema saved successfully.') }}</div>
    {% endif %}
    {% if error %}
      <div class="px-3 pb-2">{{ alert.error(error) }}</div>
    {% endif %}
    {% if auto_added %}
      <div class="px-3 pb-2">{{ alert.warning('Auto-added required system fields: ' + (auto_added | join(', '))) }}</div>
    {% endif %}
  </div>

  <div id="surveyCreatorHost" class="form-builder-canvas"></div>

  <form method="post" action="{{ url_for('form_builder') }}" id="formBuilderForm" class="d-none">
    <input type="hidden" name="survey_json" id="surveyJsonInput" value="{{ survey_json_str | e }}">
  </form>

  <details id="jsonFallbackPanel" class="m-3 d-none">
    <summary class="small text-muted-app">Fallback JSON editor</summary>
    <textarea
      id="surveyJsonEditor"
      class="form-control font-monospace mt-2"
      rows="16"
      placeholder='{"elements": [{"type": "text", "name": "team", "title": "Team Number", "isRequired": true}]}'
    >{{ survey_json_str }}</textarea>
    <div class="form-text text-muted-app mt-2">
      Creator failed to initialize. You can still edit JSON directly.
    </div>
  </details>
  <div id="jsonValidationError" class="text-danger small mx-3 mb-3 d-none"></div>
</section>
{% endblock %}

{% block extra_scripts %}
<script id="requiredFieldGroupsData" type="application/json">{{ required_field_groups | tojson | safe }}</script>
<script id="strictRequiredFieldsData" type="application/json">{{ strict_required_fields | tojson | safe }}</script>
<script src="{{ url_for('static', filename='js/form_builder.js') }}"></script>
<style>
  .form-builder-shell {
    position: fixed;
    inset: var(--form-builder-top, 56px) 0 0 0;
    display: flex;
    flex-direction: column;
    background: var(--app-bg);
    z-index: 1;
  }

  .form-builder-topbar {
    background: var(--app-surface);
  }

  .form-builder-canvas {
    flex: 1;
    min-height: 0;
    overflow: hidden;
  }

  #surveyCreatorHost {
    width: 100%;
    height: 100%;
  }

  .save-status {
    font-size: 0.78rem;
    line-height: 1;
    padding: 0.32rem 0.5rem;
    border-radius: 999px;
    border: 1px solid var(--app-border);
    color: var(--app-muted);
    background: var(--app-surface-2);
  }

  .save-status.is-unsaved {
    color: #f0ad4e;
    border-color: rgba(240, 173, 78, 0.45);
  }

  .save-status.is-saving {
    color: #6ea8fe;
    border-color: rgba(110, 168, 254, 0.45);
  }

  .save-status.is-saved {
    color: #75b798;
    border-color: rgba(117, 183, 152, 0.45);
  }

  .save-status.is-error {
    color: #ea868f;
    border-color: rgba(234, 134, 143, 0.45);
  }

  /* SurveyJS Creator Core Elements - Dark Theme */
  #surveyCreatorHost .svc-creator,
  #surveyCreatorHost .svc-full-container,
  #surveyCreatorHost .svc-creator__area {
    background-color: var(--app-bg) !important;
    color: var(--app-text) !important;
  }

  /* Top navigation and tabs */
  #surveyCreatorHost .svc-top-container,
  #surveyCreatorHost .svc-tabbed-menu,
  #surveyCreatorHost .svc-tabs {
    background-color: var(--app-surface) !important;
    border-color: var(--app-border) !important;
  }

  /* Tab buttons */
  #surveyCreatorHost .svc-tabbed-menu-item,
  #surveyCreatorHost .sv-action-bar-item {
    color: var(--app-muted) !important;
    background-color: transparent !important;
  }

  #surveyCreatorHost .svc-tabbed-menu-item--selected,
  #surveyCreatorHost .svc-tabbed-menu-item:hover,
  #surveyCreatorHost .sv-action-bar-item--pressed,
  #surveyCreatorHost .sv-action-bar-item:hover {
    color: var(--app-text) !important;
    background-color: rgba(255, 255, 255, 0.05) !important;
  }

  /* Left sidebar (toolbox) */
  #surveyCreatorHost .svc-side-bar,
  #surveyCreatorHost .svc-toolbox,
  #surveyCreatorHost .svc-toolbox__panel {
    background-color: var(--app-surface) !important;
    border-color: var(--app-border) !important;
    color: var(--app-text) !important;
  }

  /* Toolbox items */
  #surveyCreatorHost .svc-toolbox__item,
  #surveyCreatorHost .sv-list__item {
    background-color: var(--app-surface-2) !important;
    border-color: var(--app-border) !important;
    color: var(--app-text) !important;
  }

  #surveyCreatorHost .svc-toolbox__item:hover,
  #surveyCreatorHost .sv-list__item:hover {
    background-color: var(--app-surface-3) !important;
    border-color: var(--app-accent) !important;
  }

  /* Right property panel */
  #surveyCreatorHost .svc-property-panel,
  #surveyCreatorHost .svc-flex-column,
  #surveyCreatorHost .spg-root-modern {
    background-color: var(--app-surface) !important;
    border-color: var(--app-border) !important;
    color: var(--app-text) !important;
  }

  /* Property panel inputs */
  #surveyCreatorHost .spg-input,
  #surveyCreatorHost .sv-text,
  #surveyCreatorHost .spg-dropdown,
  #surveyCreatorHost .sv-dropdown {
    background-color: var(--app-surface-2) !important;
    border: 1px solid var(--app-border) !important;
    color: var(--app-text) !important;
    border-radius: var(--radius-md);
  }

  #surveyCreatorHost .spg-input:focus,
  #surveyCreatorHost .sv-text:focus,
  #surveyCreatorHost .spg-dropdown:focus,
  #surveyCreatorHost .sv-dropdown:focus {
    border-color: var(--app-accent) !important;
    box-shadow: 0 0 0 2px var(--app-accent-dim) !important;
  }

  /* Property panel labels */
  #surveyCreatorHost .spg-title,
  #surveyCreatorHost .spg-question__title,
  #surveyCreatorHost .sv-string-viewer {
    color: var(--app-text) !important;
  }

  /* Designer canvas area */
  #surveyCreatorHost .svc-tab-designer,
  #surveyCreatorHost .svc-creator__content-holder,
  #surveyCreatorHost .svc-content-wrapper {
    background-color: var(--app-bg) !important;
  }

  /* Survey page in designer */
  #surveyCreatorHost .svc-page,
  #surveyCreatorHost .svc-page__content {
    background-color: var(--app-surface) !important;
    border-color: var(--app-border) !important;
  }

  /* Questions in designer */
  #surveyCreatorHost .svc-question__content,
  #surveyCreatorHost .sd-question,
  #surveyCreatorHost .sd-page,
  #surveyCreatorHost .sd-body {
    background-color: var(--app-surface-2) !important;
    border: 1px solid var(--app-border) !important;
    color: var(--app-text) !important;
    border-radius: var(--radius-md);
  }

  #surveyCreatorHost .svc-question__content:hover {
    border-color: var(--app-accent) !important;
    box-shadow: 0 0 0 2px var(--app-accent-dim) !important;
  }

  /* Question titles and text */
  #surveyCreatorHost .sd-question__title,
  #surveyCreatorHost .sd-element__title,
  #surveyCreatorHost .sd-title,
  #surveyCreatorHost .sv-title {
    color: var(--app-text) !important;
  }

  /* Buttons in creator */
  #surveyCreatorHost .sv-btn,
  #surveyCreatorHost .sd-btn,
  #surveyCreatorHost .svc-btn {
    background: linear-gradient(135deg, var(--app-accent), var(--app-accent-hover)) !important;
    border-color: var(--app-accent) !important;
    color: white !important;
    border-radius: var(--radius-md);
  }

  #surveyCreatorHost .sv-btn:hover,
  #surveyCreatorHost .sd-btn:hover,
  #surveyCreatorHost .svc-btn:hover {
    background: linear-gradient(135deg, var(--app-accent-hover), #0b5ed7) !important;
  }

  /* Action buttons (add, delete, etc.) */
  #surveyCreatorHost .svc-action-button,
  #surveyCreatorHost .sv-action__content {
    background-color: var(--app-surface-2) !important;
    border-color: var(--app-border) !important;
    color: var(--app-text) !important;
  }

  #surveyCreatorHost .svc-action-button:hover,
  #surveyCreatorHost .sv-action__content:hover {
    background-color: var(--app-surface-3) !important;
    border-color: var(--app-accent) !important;
  }

  /* Dropdown menus and popups */
  #surveyCreatorHost .sv-popup,
  #surveyCreatorHost .sv-popup__container,
  #surveyCreatorHost .sv-list,
  #surveyCreatorHost .sv-list__container {
    background-color: var(--app-surface) !important;
    border: 1px solid var(--app-border) !important;
    color: var(--app-text) !important;
    box-shadow: var(--shadow-lg) !important;
  }

  #surveyCreatorHost .sv-list__item-body {
    color: var(--app-text) !important;
  }

  #surveyCreatorHost .sv-list__item:hover {
    background-color: var(--app-surface-3) !important;
  }

  /* Logic tab */
  #surveyCreatorHost .svc-tab-logic,
  #surveyCreatorHost .svc-logic-tab {
    background-color: var(--app-bg) !important;
    color: var(--app-text) !important;
  }

  /* Preview tab */
  #surveyCreatorHost .svc-tab-preview,
  #surveyCreatorHost .svc-preview {
    background-color: var(--app-bg) !important;
  }

  /* JSON editor tab */
  #surveyCreatorHost .svc-json-editor-tab,
  #surveyCreatorHost .svc-json-editor-area {
    background-color: var(--app-surface) !important;
    color: var(--app-text) !important;
  }

  #surveyCreatorHost .svc-json-editor-tab__content-area {
    background-color: var(--app-surface-2) !important;
    border-color: var(--app-border) !important;
  }

  #surveyCreatorHost .svc-json-editor-tab textarea,
  #surveyCreatorHost .svc-json-editor-tab pre,
  #surveyCreatorHost .svc-json-editor-tab code,
  #jsonFallbackPanel #surveyJsonEditor {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace !important;
    font-size: 13px !important;
    line-height: 1.55 !important;
    color: var(--app-text) !important;
  }

  #surveyCreatorHost .svc-json-editor-tab textarea {
    background-color: var(--app-surface-2) !important;
    caret-color: var(--app-text) !important;
    opacity: 1 !important;
  }

  #surveyCreatorHost .svc-json-editor-tab .CodeMirror,
  #surveyCreatorHost .svc-json-editor-tab .CodeMirror-code,
  #surveyCreatorHost .svc-json-editor-tab .CodeMirror-lines,
  #surveyCreatorHost .svc-json-editor-tab .cm-editor,
  #surveyCreatorHost .svc-json-editor-tab .cm-scroller,
  #surveyCreatorHost .svc-json-editor-tab .cm-content,
  #surveyCreatorHost .svc-json-editor-tab .monaco-editor,
  #surveyCreatorHost .svc-json-editor-tab .monaco-editor .view-lines,
  #surveyCreatorHost .svc-json-editor-tab .ace_editor,
  #surveyCreatorHost .svc-json-editor-tab .ace_content,
  #surveyCreatorHost .svc-json-editor-tab .ace_text-layer {
    background-color: var(--app-surface-2) !important;
    color: var(--app-text) !important;
    opacity: 1 !important;
  }

  #surveyCreatorHost .svc-json-editor-tab .CodeMirror-line,
  #surveyCreatorHost .svc-json-editor-tab .CodeMirror-linenumber,
  #surveyCreatorHost .svc-json-editor-tab .cm-line,
  #surveyCreatorHost .svc-json-editor-tab .cm-gutters,
  #surveyCreatorHost .svc-json-editor-tab .cm-activeLine,
  #surveyCreatorHost .svc-json-editor-tab .cm-activeLineGutter,
  #surveyCreatorHost .svc-json-editor-tab .monaco-editor .mtk1,
  #surveyCreatorHost .svc-json-editor-tab .ace_line,
  #surveyCreatorHost .svc-json-editor-tab .ace_gutter-cell {
    color: var(--app-text) !important;
  }

  #surveyCreatorHost .svc-json-editor-tab .svc-json-editor-tab__content-area,
  #surveyCreatorHost .svc-json-editor-tab .svc-json-editor-tab__content-area * {
    opacity: 1 !important;
  }

  #surveyCreatorHost .svc-json-editor-tab .ace_string,
  #surveyCreatorHost .svc-json-editor-tab .cm-string,
  #surveyCreatorHost .svc-json-editor-tab .CodeMirror-string {
    color: #a5d6a7 !important;
  }

  #surveyCreatorHost .svc-json-editor-tab .ace_variable,
  #surveyCreatorHost .svc-json-editor-tab .ace_property,
  #surveyCreatorHost .svc-json-editor-tab .cm-property,
  #surveyCreatorHost .svc-json-editor-tab .CodeMirror-property {
    color: #90caf9 !important;
  }

  #surveyCreatorHost .svc-json-editor-tab .ace_constant.ace_numeric,
  #surveyCreatorHost .svc-json-editor-tab .ace_constant.ace_language.ace_boolean,
  #surveyCreatorHost .svc-json-editor-tab .cm-number,
  #surveyCreatorHost .svc-json-editor-tab .cm-atom,
  #surveyCreatorHost .svc-json-editor-tab .CodeMirror-number,
  #surveyCreatorHost .svc-json-editor-tab .CodeMirror-atom {
    color: #ffab91 !important;
  }

  /* Scrollbars in creator */
  #surveyCreatorHost ::-webkit-scrollbar {
    width: 12px;
    height: 12px;
  }

  #surveyCreatorHost ::-webkit-scrollbar-track {
    background: var(--app-surface);
  }

  #surveyCreatorHost ::-webkit-scrollbar-thumb {
    background: var(--app-surface-3);
    border-radius: var(--radius-sm);
  }

  #surveyCreatorHost ::-webkit-scrollbar-thumb:hover {
    background: var(--app-border-hover);
  }

  /* Panel headers */
  #surveyCreatorHost .spg-panel__title,
  #surveyCreatorHost .spg-row__title {
    background-color: var(--app-surface-2) !important;
    color: var(--app-text) !important;
    border-color: var(--app-border) !important;
  }

  /* Checkboxes and radio buttons */
  #surveyCreatorHost .sv-checkbox,
  #surveyCreatorHost .sv-radio,
  #surveyCreatorHost .sd-checkbox,
  #surveyCreatorHost .sd-radio {
    background-color: var(--app-surface-2) !important;
    border-color: var(--app-border) !important;
  }

  #surveyCreatorHost .sv-checkbox:checked,
  #surveyCreatorHost .sv-radio:checked {
    background-color: var(--app-accent) !important;
    border-color: var(--app-accent) !important;
  }

  /* Separators and dividers */
  #surveyCreatorHost .sv-action-bar-separator,
  #surveyCreatorHost .svc-separator {
    background-color: var(--app-border) !important;
  }

  /* Icons */
  #surveyCreatorHost .sv-svg-icon,
  #surveyCreatorHost use {
    fill: currentColor;
  }
</style>
{% endblock %}
