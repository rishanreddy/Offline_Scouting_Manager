{% extends "base.html" %}
{% set current_page = 'form_builder' %}
{% import 'components/alert.html' as alert %}

{% block title %}Form Builder - Offline Scouting Manager{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/surveyjs/core/survey-core.min.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/surveyjs/creator/survey-creator-core.min.css') }}">
<script src="{{ url_for('static', filename='vendor/surveyjs/core/survey.core.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/surveyjs/core/survey-js-ui.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/surveyjs/themes/layered-dark.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/surveyjs/creator/survey-creator-core.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/surveyjs/creator/survey-creator-js.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/surveyjs/creator/survey-creator-themes-index.min.js') }}"></script>
{% endblock %}

{% block content %}
<section class="form-builder-shell">
  <div class="form-builder-topbar border-bottom border-app">
    <div class="d-flex align-items-center justify-content-between px-3 py-2">
      <div>
        <h1 class="h6 mb-0">Survey Form Builder</h1>
      </div>
      <div class="d-flex gap-2">
        <a href="{{ url_for('settings') }}" class="btn btn-outline-secondary btn-sm">Back to Settings</a>
        <button type="button" id="graphSettingsBtn" class="btn btn-outline-primary btn-sm">Graph Settings</button>
        <button type="button" id="saveFormBtn" class="btn btn-primary btn-sm">Save Form</button>
      </div>
    </div>
    {% if saved %}
      <div class="px-3 pb-2">{{ alert.success('Form schema saved successfully.') }}</div>
    {% endif %}
    {% if error %}
      <div class="px-3 pb-2">{{ alert.error(error) }}</div>
    {% endif %}
    {% if auto_added %}
      <div class="px-3 pb-2">{{ alert.warning('Auto-added required system fields: ' + (auto_added | join(', '))) }}</div>
    {% endif %}
  </div>

  <div id="surveyCreatorHost" class="form-builder-canvas"></div>

  <form method="post" action="{{ url_for('form_builder') }}" id="formBuilderForm" class="d-none">
    <input type="hidden" name="survey_json" id="surveyJsonInput" value="{{ survey_json_str | e }}">
    <input type="hidden" name="graph_config_json" id="graphConfigInput" value="{{ graph_config_json | e }}">
  </form>

  <div class="modal fade" id="graphSettingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Graph Mapping</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="small text-muted-app">Choose which fields appear in analysis graphs and the chart type for each.</p>
          <div class="table-responsive">
            <table class="table table-striped table-hover table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>Field</th>
                  <th style="width: 120px;">Graph?</th>
                  <th style="width: 180px;">Chart Type</th>
                </tr>
              </thead>
              <tbody id="graphConfigBody"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <details id="jsonFallbackPanel" class="m-3 d-none">
    <summary class="small text-muted-app">Fallback JSON editor</summary>
    <textarea
      id="surveyJsonEditor"
      class="form-control font-monospace mt-2"
      rows="16"
      placeholder='{"elements": [{"type": "text", "name": "team", "title": "Team Number", "isRequired": true}]}'
    >{{ survey_json_str }}</textarea>
    <div class="form-text text-muted-app mt-2">
      Creator failed to initialize. You can still edit JSON directly.
    </div>
  </details>
  <div id="jsonValidationError" class="text-danger small mx-3 mb-3 d-none"></div>
</section>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/form_builder.js') }}"></script>
<style>
  .form-builder-shell {
    position: fixed;
    inset: var(--form-builder-top, 56px) 0 0 0;
    display: flex;
    flex-direction: column;
    background: var(--app-bg);
    z-index: 1;
  }

  .form-builder-topbar {
    background: var(--app-surface);
  }

  .form-builder-canvas {
    flex: 1;
    min-height: 0;
    overflow: hidden;
  }

  #surveyCreatorHost {
    width: 100%;
    height: 100%;
  }

  /* SurveyJS Creator Core Elements - Dark Theme */
  #surveyCreatorHost .svc-creator,
  #surveyCreatorHost .svc-full-container,
  #surveyCreatorHost .svc-creator__area {
    background-color: var(--app-bg) !important;
    color: var(--app-text) !important;
  }

  /* Top navigation and tabs */
  #surveyCreatorHost .svc-top-container,
  #surveyCreatorHost .svc-tabbed-menu,
  #surveyCreatorHost .svc-tabs {
    background-color: var(--app-surface) !important;
    border-color: var(--app-border) !important;
  }

  /* Tab buttons */
  #surveyCreatorHost .svc-tabbed-menu-item,
  #surveyCreatorHost .sv-action-bar-item {
    color: var(--app-muted) !important;
    background-color: transparent !important;
  }

  #surveyCreatorHost .svc-tabbed-menu-item--selected,
  #surveyCreatorHost .svc-tabbed-menu-item:hover,
  #surveyCreatorHost .sv-action-bar-item--pressed,
  #surveyCreatorHost .sv-action-bar-item:hover {
    color: var(--app-text) !important;
    background-color: rgba(255, 255, 255, 0.05) !important;
  }

  /* Left sidebar (toolbox) */
  #surveyCreatorHost .svc-side-bar,
  #surveyCreatorHost .svc-toolbox,
  #surveyCreatorHost .svc-toolbox__panel {
    background-color: var(--app-surface) !important;
    border-color: var(--app-border) !important;
    color: var(--app-text) !important;
  }

  /* Toolbox items */
  #surveyCreatorHost .svc-toolbox__item,
  #surveyCreatorHost .sv-list__item {
    background-color: var(--app-surface-2) !important;
    border-color: var(--app-border) !important;
    color: var(--app-text) !important;
  }

  #surveyCreatorHost .svc-toolbox__item:hover,
  #surveyCreatorHost .sv-list__item:hover {
    background-color: var(--app-surface-3) !important;
    border-color: var(--app-accent) !important;
  }

  /* Right property panel */
  #surveyCreatorHost .svc-property-panel,
  #surveyCreatorHost .svc-flex-column,
  #surveyCreatorHost .spg-root-modern {
    background-color: var(--app-surface) !important;
    border-color: var(--app-border) !important;
    color: var(--app-text) !important;
  }

  /* Property panel inputs */
  #surveyCreatorHost .spg-input,
  #surveyCreatorHost .sv-text,
  #surveyCreatorHost .spg-dropdown,
  #surveyCreatorHost .sv-dropdown {
    background-color: var(--app-surface-2) !important;
    border: 1px solid var(--app-border) !important;
    color: var(--app-text) !important;
    border-radius: var(--radius-md);
  }

  #surveyCreatorHost .spg-input:focus,
  #surveyCreatorHost .sv-text:focus,
  #surveyCreatorHost .spg-dropdown:focus,
  #surveyCreatorHost .sv-dropdown:focus {
    border-color: var(--app-accent) !important;
    box-shadow: 0 0 0 2px var(--app-accent-dim) !important;
  }

  /* Property panel labels */
  #surveyCreatorHost .spg-title,
  #surveyCreatorHost .spg-question__title,
  #surveyCreatorHost .sv-string-viewer {
    color: var(--app-text) !important;
  }

  /* Designer canvas area */
  #surveyCreatorHost .svc-tab-designer,
  #surveyCreatorHost .svc-creator__content-holder,
  #surveyCreatorHost .svc-content-wrapper {
    background-color: var(--app-bg) !important;
  }

  /* Survey page in designer */
  #surveyCreatorHost .svc-page,
  #surveyCreatorHost .svc-page__content {
    background-color: var(--app-surface) !important;
    border-color: var(--app-border) !important;
  }

  /* Questions in designer */
  #surveyCreatorHost .svc-question__content,
  #surveyCreatorHost .sd-question,
  #surveyCreatorHost .sd-page,
  #surveyCreatorHost .sd-body {
    background-color: var(--app-surface-2) !important;
    border: 1px solid var(--app-border) !important;
    color: var(--app-text) !important;
    border-radius: var(--radius-md);
  }

  #surveyCreatorHost .svc-question__content:hover {
    border-color: var(--app-accent) !important;
    box-shadow: 0 0 0 2px var(--app-accent-dim) !important;
  }

  /* Question titles and text */
  #surveyCreatorHost .sd-question__title,
  #surveyCreatorHost .sd-element__title,
  #surveyCreatorHost .sd-title,
  #surveyCreatorHost .sv-title {
    color: var(--app-text) !important;
  }

  /* Buttons in creator */
  #surveyCreatorHost .sv-btn,
  #surveyCreatorHost .sd-btn,
  #surveyCreatorHost .svc-btn {
    background: linear-gradient(135deg, var(--app-accent), var(--app-accent-hover)) !important;
    border-color: var(--app-accent) !important;
    color: white !important;
    border-radius: var(--radius-md);
  }

  #surveyCreatorHost .sv-btn:hover,
  #surveyCreatorHost .sd-btn:hover,
  #surveyCreatorHost .svc-btn:hover {
    background: linear-gradient(135deg, var(--app-accent-hover), #0b5ed7) !important;
  }

  /* Action buttons (add, delete, etc.) */
  #surveyCreatorHost .svc-action-button,
  #surveyCreatorHost .sv-action__content {
    background-color: var(--app-surface-2) !important;
    border-color: var(--app-border) !important;
    color: var(--app-text) !important;
  }

  #surveyCreatorHost .svc-action-button:hover,
  #surveyCreatorHost .sv-action__content:hover {
    background-color: var(--app-surface-3) !important;
    border-color: var(--app-accent) !important;
  }

  /* Dropdown menus and popups */
  #surveyCreatorHost .sv-popup,
  #surveyCreatorHost .sv-popup__container,
  #surveyCreatorHost .sv-list,
  #surveyCreatorHost .sv-list__container {
    background-color: var(--app-surface) !important;
    border: 1px solid var(--app-border) !important;
    color: var(--app-text) !important;
    box-shadow: var(--shadow-lg) !important;
  }

  #surveyCreatorHost .sv-list__item-body {
    color: var(--app-text) !important;
  }

  #surveyCreatorHost .sv-list__item:hover {
    background-color: var(--app-surface-3) !important;
  }

  /* Logic tab */
  #surveyCreatorHost .svc-tab-logic,
  #surveyCreatorHost .svc-logic-tab {
    background-color: var(--app-bg) !important;
    color: var(--app-text) !important;
  }

  /* Preview tab */
  #surveyCreatorHost .svc-tab-preview,
  #surveyCreatorHost .svc-preview {
    background-color: var(--app-bg) !important;
  }

  /* JSON editor tab */
  #surveyCreatorHost .svc-json-editor-tab,
  #surveyCreatorHost .svc-json-editor-area {
    background-color: var(--app-surface) !important;
    color: var(--app-text) !important;
  }

  #surveyCreatorHost .svc-json-editor-tab__content-area {
    background-color: var(--app-surface-2) !important;
    border-color: var(--app-border) !important;
  }

  /* Scrollbars in creator */
  #surveyCreatorHost ::-webkit-scrollbar {
    width: 12px;
    height: 12px;
  }

  #surveyCreatorHost ::-webkit-scrollbar-track {
    background: var(--app-surface);
  }

  #surveyCreatorHost ::-webkit-scrollbar-thumb {
    background: var(--app-surface-3);
    border-radius: var(--radius-sm);
  }

  #surveyCreatorHost ::-webkit-scrollbar-thumb:hover {
    background: var(--app-border-hover);
  }

  /* Remove any conflicting light theme defaults */
  #surveyCreatorHost * {
    border-color: var(--app-border);
  }

  /* Panel headers */
  #surveyCreatorHost .spg-panel__title,
  #surveyCreatorHost .spg-row__title {
    background-color: var(--app-surface-2) !important;
    color: var(--app-text) !important;
    border-color: var(--app-border) !important;
  }

  /* Checkboxes and radio buttons */
  #surveyCreatorHost .sv-checkbox,
  #surveyCreatorHost .sv-radio,
  #surveyCreatorHost .sd-checkbox,
  #surveyCreatorHost .sd-radio {
    background-color: var(--app-surface-2) !important;
    border-color: var(--app-border) !important;
  }

  #surveyCreatorHost .sv-checkbox:checked,
  #surveyCreatorHost .sv-radio:checked {
    background-color: var(--app-accent) !important;
    border-color: var(--app-accent) !important;
  }

  /* Separators and dividers */
  #surveyCreatorHost .sv-action-bar-separator,
  #surveyCreatorHost .svc-separator {
    background-color: var(--app-border) !important;
  }

  /* Icons */
  #surveyCreatorHost .sv-svg-icon,
  #surveyCreatorHost use {
    fill: currentColor;
  }
</style>
{% endblock %}
