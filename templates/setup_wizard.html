{% extends "base.html" %}
{% block title %}Setup - Offline Scouting Manager{% endblock %}

{% block content %}
<section class="py-5 setup-wizard-page">
  <div class="container setup-wizard-container">
    <div class="text-center mb-5">
      <h1 class="setup-wizard-heading">Welcome to Offline Scouting Manager</h1>
      <p class="setup-wizard-subheading">Set up your device in a few quick steps.</p>
      {% if current_version %}
      <div class="setup-wizard-version">Version {{ current_version }}</div>
      {% endif %}
    </div>

    {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <div class="card setup-wizard-card">
      <div class="card-body">
        <div id="wizardLive" class="visually-hidden" aria-live="polite"></div>

        <div class="setup-wizard-progress mb-5">
          <div class="d-flex justify-content-between align-items-center gap-3 setup-step-labels mb-3" aria-hidden="true">
            <div class="setup-step-label-wrapper" data-step-label="1">
              <div class="setup-step-number">1</div>
              <div class="setup-step-label">Event</div>
            </div>
            <div class="setup-step-connector"></div>
            <div class="setup-step-label-wrapper" data-step-label="2">
              <div class="setup-step-number">2</div>
              <div class="setup-step-label">Device</div>
            </div>
            <div class="setup-step-connector"></div>
            <div class="setup-step-label-wrapper" data-step-label="3">
              <div class="setup-step-number">3</div>
              <div class="setup-step-label">Review</div>
            </div>
          </div>
          <div class="visually-hidden" role="progressbar" aria-label="Setup progress" aria-valuemin="1" aria-valuemax="3" aria-valuenow="1" aria-valuetext="Step 1 of 3" id="progressAriaContainer"></div>
        </div>

        <form id="setupForm" method="post" action="{{ url_for('setup_wizard') }}" enctype="multipart/form-data">
          <!-- Step 1 -->
          <div class="wizard-step" data-step="1">
            <h2 class="h5 setup-step-title">Event Setup</h2>
            <p class="text-muted-app mb-3">Create this event profile, or import an exported setup file to preload your configuration.</p>
            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <label class="form-label">Event Name</label>
                <input type="text" name="event_name" id="eventNameInput" class="form-control" placeholder="e.g., Rebuilt Regional" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Season</label>
                <input type="text" name="season" class="form-control" placeholder="e.g., 2026-2026">
              </div>
            </div>

            <div class="mt-4 setup-import-zone">
              <label class="form-label d-flex align-items-center gap-2" for="setupFileInput">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                  <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                </svg>
                Import setup file (optional)
              </label>
              <div class="setup-file-input-wrapper">
                <input type="file" id="setupFileInput" name="setup_file" class="setup-file-input" accept=".yaml,.yml" />
                <label for="setupFileInput" class="setup-file-label">
                  <div class="setup-file-icon">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M5 8a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5A.5.5 0 0 1 5 8zm0-2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0 5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                      <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm10-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1z"/>
                    </svg>
                  </div>
                  <div class="setup-file-text">
                    <span class="setup-file-placeholder">Choose file or drag here</span>
                    <span class="setup-file-selected d-none"></span>
                  </div>
                </label>
              </div>
              <div class="form-text text-muted-app mt-2">
                Recommended if you already exported from another device. This imports event fields and survey settings.
              </div>
            </div>
          </div>

          <!-- Step 2 -->
          <div class="wizard-step d-none" data-step="2">
            <h2 class="h5 setup-step-title">Device ID and Data Actions</h2>
            <p class="small text-muted-app">Your device ID is generated automatically and stays stable across app restarts and data clears.</p>

            <div class="card bg-app-surface-2 border-app mb-3">
              <div class="card-body p-3">
                <div class="small text-muted-app mb-1">Auto-generated Device ID</div>
                <div class="device-id-preview-wrapper">
                  <code class="device-id-preview" id="deviceIdPreview" data-full-id="{{ device_id_preview if device_id_preview else 'Generating...' }}">{{ format_device_id(device_id_preview) if device_id_preview else 'Generating...' }}</code>
                  <button
                    type="button"
                    class="btn btn-sm btn-link device-id-copy-btn-wizard"
                    title="Copy full device ID"
                    aria-label="Copy full device ID to clipboard"
                    data-device-id="{{ device_id_preview if device_id_preview else '' }}"
                  >
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                      <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                      <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <div class="mt-4">
              <label class="form-label">Data for this version</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="data_action" id="dataKeep" value="keep" checked>
                <label class="form-check-label" for="dataKeep">
                  Keep existing data
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="data_action" id="dataReset" value="reset">
                <label class="form-check-label" for="dataReset">
                  Start fresh (clears all local data on this device)
                </label>
                <div class="form-text setup-danger-text">
                  Destructive action: existing match records and synced data on this device will be removed during setup.
                </div>
              </div>
            </div>
          </div>

          <!-- Step 3 -->
          <div class="wizard-step d-none" data-step="3">
            <h2 class="h5 setup-step-title">Review and Confirm</h2>
            <p class="small text-muted-app">Confirm the setup details below, then finish setup.</p>

            <div class="setup-review card bg-app-surface-2 border-app">
              <div class="card-body p-3">
                <dl class="row mb-0 small">
                  <dt class="col-5 text-muted-app">Event Name</dt>
                  <dd class="col-7 mb-2" id="reviewEventName">-</dd>
                  <dt class="col-5 text-muted-app">Season</dt>
                  <dd class="col-7 mb-2" id="reviewSeason">-</dd>
                  <dt class="col-5 text-muted-app">Setup File</dt>
                  <dd class="col-7 mb-2" id="reviewSetupFile">None selected</dd>
                  <dt class="col-5 text-muted-app">Device ID</dt>
                  <dd class="col-7 mb-2" id="reviewDeviceId">{{ format_device_id(device_id_preview) if device_id_preview else '-' }}</dd>
                  <dt class="col-5 text-muted-app">Data Action</dt>
                  <dd class="col-7 mb-0" id="reviewDataAction">Keep existing data</dd>
                </dl>
              </div>
            </div>
          </div>

          <div class="setup-wizard-actions">
            <div class="setup-wizard-actions-primary">
              <button type="button" id="prevBtn" class="btn btn-outline-secondary" disabled>
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 0.25rem;">
                  <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                </svg>
                Back
              </button>
              <button type="button" id="nextBtn" class="btn btn-primary">
                Continue
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-left: 0.25rem;">
                  <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                </svg>
              </button>
              <button type="submit" id="finishBtn" class="btn btn-primary d-none">
                Finish Setup
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-left: 0.25rem;">
                  <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z"/>
                </svg>
              </button>
            </div>
            <div class="setup-wizard-actions-secondary">
              <button type="submit" name="skip_setup" value="1" formnovalidate class="btn btn-link text-muted-app">Skip wizard and use existing settings</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/setup_wizard.js') }}"></script>
{% endblock %}
